name: Build and Deploy to EC2

on:
  push:
    branches: [ main ]

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set lower case owner name
        run: |
          echo "REPO_LOWERCASE=${GITHUB_REPOSITORY,,}" >> ${GITHUB_ENV}

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ghcr.io/${{ env.REPO_LOWERCASE }}:latest

  deploy:
    needs: build-and-push
    runs-on: self-hosted
    
    steps:
      - name: Set lower case owner name
        run: |
          echo "REPO_LOWERCASE=${GITHUB_REPOSITORY,,}" >> ${GITHUB_ENV}

      - name: Create docker-compose.prod.yml
        run: |
          sudo mkdir -p /opt/app
          cd /opt/app
          
          sudo tee docker-compose.prod.yml > /dev/null << EOF
          services:
            app:
              image: ghcr.io/${REPO_LOWERCASE}:latest
              container_name: crm-app
              restart: always
              ports:
                - "3000:3000"
              env_file: .env
              depends_on:
                db:
                  condition: service_healthy

            db:
              image: mysql:8.0
              container_name: crm-db
              restart: always
              environment:
                - MYSQL_ROOT_PASSWORD=\${MYSQL_ROOT_PASSWORD}
                - MYSQL_DATABASE=business_leads_crm
              volumes:
                - mysql_data:/var/lib/mysql
              healthcheck:
                test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p\${MYSQL_ROOT_PASSWORD}"]
                interval: 10s
                timeout: 5s
                retries: 5

          volumes:
            mysql_data:
          EOF

      - name: Login to GitHub Container Registry
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Deploy with Docker Compose
        run: |
          cd /opt/app
          docker compose -f docker-compose.prod.yml pull
          docker compose -f docker-compose.prod.yml up -d --remove-orphans
          echo "Deployment completed successfully!"
