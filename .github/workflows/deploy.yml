name: Build and Deploy to EC2

on:
  push:
    branches: [ main ]

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set lower case owner name
        run: |
          echo "REPO_LOWERCASE=${GITHUB_REPOSITORY,,}" >> ${GITHUB_ENV}

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ghcr.io/${{ env.REPO_LOWERCASE }}:latest

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - name: Set lower case owner name
        run: |
          echo "REPO_LOWERCASE=${GITHUB_REPOSITORY,,}" >> ${GITHUB_ENV}

      - name: Deploy to EC2 via SSH
        run: |
          # Decode the SSH key
          echo "${{ secrets.EC2_SSH_KEY_BASE64 }}" | base64 -d > /tmp/ssh_key
          chmod 600 /tmp/ssh_key
          
          # Create the .env file locally
          cat > /tmp/app.env << 'ENVEOF'
          ${{ secrets.ENV_FILE }}
          ENVEOF
          
          # Create docker-compose.prod.yml locally
          cat > /tmp/docker-compose.prod.yml << EOF
          services:
            app:
              image: ghcr.io/${{ env.REPO_LOWERCASE }}:latest
              container_name: crm-app
              restart: always
              ports:
                - "3000:3000"
              env_file: .env
              depends_on:
                db:
                  condition: service_healthy

            db:
              image: mysql:8.0
              container_name: crm-db
              restart: always
              environment:
                - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
                - MYSQL_DATABASE=business_leads_crm
              volumes:
                - mysql_data:/var/lib/mysql
              healthcheck:
                test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${MYSQL_ROOT_PASSWORD}"]
                interval: 10s
                timeout: 5s
                retries: 5

          volumes:
            mysql_data:
          EOF
          
          # Create app directory on server
          ssh -i /tmp/ssh_key -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "mkdir -p ~/app"
          
          # Copy files to server
          scp -i /tmp/ssh_key -o StrictHostKeyChecking=no /tmp/app.env ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:~/app/.env
          scp -i /tmp/ssh_key -o StrictHostKeyChecking=no /tmp/docker-compose.prod.yml ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:~/app/docker-compose.prod.yml
          
          # SSH and run deployment commands
          ssh -i /tmp/ssh_key -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} bash << ENDSSH
          cd ~/app

          # Login to GHCR
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

          # Pull and restart
          docker compose -f docker-compose.prod.yml pull
          docker compose -f docker-compose.prod.yml up -d --remove-orphans

          echo "Deployment completed successfully!"
          ENDSSH
          
          # Cleanup
          rm -f /tmp/ssh_key /tmp/app.env /tmp/docker-compose.prod.yml
